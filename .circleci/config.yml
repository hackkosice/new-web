version: 2.1
orbs:
  hugo: circleci/hugo@0.5.2
  firebase-deploy: azdevs/firebase-deploy@1.0.0
parameters:
  hugo-version:
    type: string
    default: '0.73'
  deploy-branch:
    type: string
    default: 'master'
jobs:
  build:
    executor:
      name: hugo/cibuilds
      tag: << pipeline.parameters.hugo-version >>
    parameters:
      html-proofer:
        default: true
        description: Whether or not to test the outputted HTML with HTML Proofer.
        type: boolean
    steps:
      - checkout
      - hugo/hugo-build:
          extra-flags: -DF
      - when:
          condition: << parameters.html-proofer >>
          steps:
            - hugo/html-proofer:
                path: ./public
  deploy_dev:
    parameters:
      baseurl:
        type: string
    docker:
      - image: cibuilds/base
    steps:
      - add_ssh_keys
      - run:
          name: Deploy at server
          command: |
            echo 'hackkosice.com ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBCHgOExXpEGEvZ1Usofy87wMdTgOwKtEwoHft6q2MTuup25f4bmgj3SyB5/sjpySSs0ti7Vg60EtzRMMvRSXbv4=' >> ~/.ssh/known_hosts
            ssh hackkosice@hackkosice.com '
              cd dev.hackkosice.com/repository
              git checkout << pipeline.parameters.deploy-branch >>
              git pull
              rm -r public
              hugo --baseURL="<< parameters.baseurl >>" -DF
              cp -r public/* ../public_html'
  build_firebase:
    parameters:
      baseurl:
        type: string
      html-proofer:
        default: false
        description: Whether or not to test the outputted HTML with HTML Proofer.
        type: boolean
    executor:
      name: hugo/cibuilds
      tag: << pipeline.parameters.hugo-version >>
    environment:
      TZ: "Europe/Bratislava"
    steps:
      - checkout
      - hugo/hugo-build:
          extra-flags: --baseURL="<< parameters.baseurl >>"
      - when:
          condition: << parameters.html-proofer >>
          steps:
            - hugo/html-proofer:
                path: ./public
      - persist_to_workspace:
          root: .
          paths:
            - public
            - firebase.json
            - .firebaserc
            - firestore.rules
            - firestore.indexes.json
            - functions/
  deploy_firebase:
    docker:
      - image: circleci/node:lts
    steps:
      - attach_workspace:
          at: ~/project
      - restore_cache:
          keys:
            # Find a cache corresponding to this specific package-lock.json
            - npm-deps-v1-{{ checksum "functions/package-lock.json" }}
            # Fallback cache to be used
            - npm-deps-v1-
      - run:
          name: Install Dependencies
          command: cd functions && npm install
      - save_cache:
          key: npm-deps-v1-{{ checksum "functions/package-lock.json" }}
          paths:
            - functions/node_modules
      - firebase-deploy/deploy:
          token: $FIREBASE_TOKEN
workflows:
  main:
    jobs:
      - build_firebase:
          baseurl: 'https://hackkosice.com/'
          filters:
            branches:
              only: << pipeline.parameters.deploy-branch >>
      - deploy_firebase:
          filters:
            branches:
              only: << pipeline.parameters.deploy-branch >>
          requires:
            - build_firebase
